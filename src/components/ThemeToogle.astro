---
import LightModeIcon from "@components/icons/LightMode.astro";
import DarkModeIcon from "@components/icons/DarkMode.astro";
---

<button
  id="themeToggle"
  class="border-0 background-none cursor-pointer"
  aria-label="Toggle Dark Mode"
>
  <LightModeIcon class="sun dark:hidden" />
  <DarkModeIcon class="moon hidden dark:block" />
</button>

<script is:inline>
  (function () {
    const safeLocal = {
      get(key) {
        try {
          if (typeof window === "undefined" || !window.localStorage)
            return null;
          return window.localStorage.getItem(key);
        } catch (e) {
          return null;
        }
      },
      set(key, value) {
        try {
          if (typeof window === "undefined" || !window.localStorage) return;
          window.localStorage.setItem(key, value);
        } catch (e) {
        }
      },
    };

    const prefersDark = (() => {
      try {
        return (
          typeof window !== "undefined" &&
          typeof window.matchMedia === "function" &&
          window.matchMedia("(prefers-color-scheme: dark)").matches
        );
      } catch (e) {
        return false;
      }
    })();

    const getPreferredTheme = () => {
      const stored = safeLocal.get("theme");
      if (stored === "dark" || stored === "light") return stored;
      return prefersDark ? "dark" : "light";
    };

    const applyTheme = (theme) => {
      try {
        if (typeof document === "undefined" || !document.documentElement)
          return;
        if (theme === "dark") document.documentElement.classList.add("dark");
        else document.documentElement.classList.remove("dark");
      } catch (e) {
        console.error("applyTheme error:", e);
      }
    };

    const theme = getPreferredTheme();
    applyTheme(theme);
    safeLocal.set("theme", theme);

    const handleToggleClick = () => {
      try {
        const element = document && document.documentElement;
        if (!element) return;
        const isDark = element.classList.toggle("dark");
        safeLocal.set("theme", isDark ? "dark" : "light");
      } catch (e) {
        console.error("Theme toggle failed:", e);
      }
    };

    const attachHandler = () => {
      try {
        if (typeof document === "undefined") return;
        const btn =
          document.getElementById("themeToggle") ||
          document.querySelector('button[aria-label="Toggle Dark Mode"]');
        if (btn && btn.addEventListener) {
          btn.addEventListener("click", handleToggleClick);
        } else {
          console.warn("Theme toggle button not found to attach handler.");
        }
      } catch (e) {
        console.warn("Could not attach theme toggle handler:", e);
      }
    };

    if (typeof document !== "undefined") {
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", attachHandler);
      } else {
        attachHandler();
      }
    }
  })();
</script>
